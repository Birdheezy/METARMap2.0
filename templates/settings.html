<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEARMap Settings</title>
    <link href="{{ url_for('static', filename='css/settings.css') }}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='settings.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <!-- Add Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar">
    <a href="#brightness">Brightness</a>
    <a href="#color">Color</a>
    <a href="#animation">Animation</a>
    <a href="#time-settings">Time</a>
    <a href="#airports">Airports</a>
    <a href="#wifi-settings">Wifi</a>
</nav>

<div class="container">
    <!-- Title Section -->
    <div style="margin-top: 30px; margin-bottom: 40px; text-align: center;">
        <h1>METARMap 2.0</h1>
        <div style="font-size: 1.1em; color: #cccccc; font-family: 'Orbitron', sans-serif; letter-spacing: 1px;">
            Settings & Configuration </br>
            Thanks for checking out this project! </br>
            If you have any issues/comments/suggestions, please visit <a href="https://github.com/Birdheezy/METARMap2.0/tree/production">this link.</a>
        </div>
    </div>
    <section>
        <h2>Airport Map</h2>
        <div id="airport-map" style="height: 450px; margin-bottom: 10px; border-radius: 8px;"></div>
        <div class="map-legend">
            <span class="legend-item">
                <span class="legend-dot vfr"></span>VFR
            </span>
            <span class="legend-item">
                <span class="legend-dot mvfr"></span>MVFR
            </span>
            <span class="legend-item">
                <span class="legend-dot ifr"></span>IFR
            </span>
            <span class="legend-item">
                <span class="legend-dot lifr"></span>LIFR
            </span>
            <span class="legend-item">
                <span class="legend-dot missing"></span>Missing
            </span>
            <span class="legend-item">
                <span class="legend-dot lightning"></span>Lightning
            </span>
            <span class="legend-item">
                <span class="legend-dot snow"></span>Snow
            </span>
        </div>
        <br>
        <div style="margin-top: 5px;" class="weather-status">
                <div class="service-status">
                    <span class="status-dot" id="map-weather-status-dot"></span>
                    <span class="status-text">WX Last Updated: <span id="map-weather-last-updated">{{ weather_last_modified }}</span></span>
                    <div class="status-tooltip">
                        <span class="green-status">Green: Weather data is current (within expected update interval)</span><br>
                        <span class="red-status">Red: Weather data is stale (no updates for over 2x the update interval)</span>
                    </div>
                </div>
            </div>
        <br>
        <button type="button" id="save-map-view" class="btn btn-primary" style="margin-bottom: 20px;">Save Current View</button>
    </section>

    <form method="POST" action="/" onsubmit="saveScrollPosition()">
    <section id="brightness">

        <h2>Brightness Settings</h2>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="brightness">Default Brightness (0.01 to 1.0)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Adjusts the default LED brightness between 0.01 (minimum) and 1 (maximum)
                </div>
            </div>
            <input type="text" class="form-control input-small" name="brightness" value="{{ config.BRIGHTNESS }}" placeholder="Default: 0.5">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="daytime_dim_brightness">Night/Dimmed Brightness (0.01 to 1.0)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    The LED brightness between "Dim time Start" and "Bright time start". Between 0.01 (minimum) and 1 (maximum)
                </div>
            </div>
            <input type="text" class="form-control input-small" name="daytime_dim_brightness" value="{{ config.DAYTIME_DIM_BRIGHTNESS }}" placeholder="Default: 0.2">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="dim_brightness">Windy Dim Brightness (0.01 to 1.0)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
            <div class="dropdown-content" style="display: none;">
                How dim the LED will get when executing the windy animation. Range is between 0.01 (minimum) 1 (maximum)
            </div>
        </div>
            <input type="text" class="form-control input-small" name="dim_brightness" value="{{ config.DIM_BRIGHTNESS }}" placeholder="Default: 0.05">
        </div>
    </section>

    <section id="color">
        <h2>Color Settings</h2>
        <div class="color-settings-container">
            <!-- Flight Categories Column -->
            <div class="color-column">
                <h3>Flight Categories</h3>
                <div class="color-picker-list">
                    <div class="color-picker-row">
                        <label for="vfr-color-picker">VFR Color:</label>
                        <input type="color" id="vfr-color-picker" name="vfr_color" value="{{ vfr_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="mvfr-color-picker">MVFR Color:</label>
                        <input type="color" id="mvfr-color-picker" name="mvfr_color" value="{{ mvfr_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="ifr-color-picker">IFR Color:</label>
                        <input type="color" id="ifr-color-picker" name="ifr_color" value="{{ ifr_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="lifr-color-picker">LIFR Color:</label>
                        <input type="color" id="lifr-color-picker" name="lifr_color" value="{{ lifr_color }}">
                    </div>
                </div>
            </div>

            <!-- Special Conditions Column -->
            <div class="color-column">
                <h3>Special Conditions</h3>
                <div class="color-picker-list">
                    <div class="color-picker-row">
                        <label for="lightening-color-picker">Lightning Color:</label>
                        <input type="color" id="lightening-color-picker" name="lightening_color" value="{{ lightening_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="snowy-color-picker">Snowy Color:</label>
                        <input type="color" id="snowy-color-picker" name="snowy_color" value="{{ snowy_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="missing-color-picker">Missing Color:</label>
                        <input type="color" id="missing-color-picker" name="missing_color" value="{{ missing_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="stale-data-color-picker">Stale WX Data Color:</label>
                        <input type="color" id="stale-data-color-picker" name="stale_data_color" value="{{ stale_data_color }}">
                    </div>
                    <div class="color-picker-row">
                        <label for="wifi-disconnected-color-picker">WiFi Disconnected Color:</label>
                        <input type="color" id="wifi-disconnected-color-picker" name="wifi_disconnected_color" value="{{ wifi_disconnected_color }}">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- LED Testing Section -->
    <section id="led-testing" class="dark-section">
        <h2 class="section-title">LED Testing</h2>
        
        <!-- Automated Test -->
        <div class="test-section">
            <h3 class="subsection-title">Automated Test</h3>
            <div class="test-buttons">
                <div class="button-row">
                    <button type="button" class="btn btn-primary" id="run-auto-test">Start Color Test</button>
                    <button type="button" class="btn btn-primary service-btn" onclick="event.preventDefault(); controlService('metar', 'stop')">Stop METAR Service</button>
                </div>
                <div class="button-row">
                    <button type="button" class="btn btn-primary" id="next-color" style="display: none;">Next Color</button>
                    <button type="button" class="btn btn-primary" id="stop-auto-test" style="display: none;">Stop Test</button>
                </div>
            </div>
            <div id="test-progress" style="display: none;">
                <div class="progress">
                    <div class="progress-bar" role="progressbar"></div>
                </div>
                <div id="test-status">Testing: VFR Color</div>
            </div>
        </div>

        <!-- Manual Test -->
        <div class="test-section">
            <h3 class="subsection-title">Manual Test</h3>
            <div class="color-buttons">
                <div class="button-grid">
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ vfr_color }}">Test VFR</button>
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ mvfr_color }}">Test MVFR</button>
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ ifr_color }}">Test IFR</button>
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ lifr_color }}">Test LIFR</button>
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ lightening_color }}">Test Lightning</button>
                    <button type="button" class="btn btn-primary led-test-btn" data-color="{{ snowy_color }}">Test Snow</button>
                </div>
            </div>
            
            <!-- Custom Color Test -->
            <div class="custom-color-test">
                <div class="input-group">
                    <label for="custom-led-color">Custom Color:</label>
                    <input type="color" id="custom-led-color" value="#ffffff">
                    <button type="button" class="btn btn-primary" id="test-custom-color">Test</button>
                </div>
            </div>

            <!-- All Off Button -->
            <div class="led-controls">
                <button type="button" class="btn btn-primary" id="turn-off-leds">Turn Off All LEDs</button>
            </div>
        </div>
    </section>

    <!-- Animation Settings -->

    <section id="animation">

        <h2>Animation Settings</h2>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="weather_update_interval">Weather Update Interval (in minutes)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Sets how often the weather data is updated automatically, in minutes. Default is 5 minutes.
                </div>
            </div>
            <input type="text" class="form-control input-small" name="weather_update_interval" value="{{ config.WEATHER_UPDATE_INTERVAL // 60 }}" placeholder="Default: 5">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="animation_pause">Animation Pause Time (in seconds)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Sets the duration of pause between each animation cycle, in seconds.
                </div>
            </div>
            <input type="text" class="form-control input-small" name="animation_pause" value="{{ config.ANIMATION_PAUSE }}" placeholder="Default: 15">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="wind_threshold">Wind Threshold
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Steady state or gust over this value in knots will trigger the windy animation
                </div>
            </div>
            <input type="text" class="form-control input-small" name="wind_threshold" value="{{ config.WIND_THRESHOLD }}" placeholder="Default: 15">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="wind_fade_time">Wind Fade Time (in seconds)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    How long it takes the LED to fade from bright to dim/dim to bright, in seconds
                </div>
            </div>
            <input type="text" class="form-control input-small" name="wind_fade_time" value="{{ config.WIND_FADE_TIME }}" placeholder="Default: 0.5">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="wind_pause">Wind Fade Pause Time (in seconds)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    How long the LED will be pause at the dim brigthness when executing the windy animation, in seconds
                </div>
            </div>
            <input type="text" class="form-control input-small" name="wind_pause" value="{{ config.WIND_PAUSE }}" placeholder="Default: 1.0">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="lightning_flash_count">Lightning Flash Count
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Sets the number of flashes that occur during the lightning animation.
                </div>
            </div>
            <input type="text" class="form-control input-small" name="lightning_flash_count" value="{{ config.LIGHTNING_FLASH_COUNT }}" placeholder="Default: 2">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="snow_blink_count">Snow Blink Count
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Sets the number of blinks during the snowy animation.
                </div>
            </div>
            <input type="text" class="form-control input-small" name="snow_blink_count" value="{{ config.SNOW_BLINK_COUNT }}" placeholder="Default: 2">
        </div>

        <div class="mb-3">
            <div class="dropdown-container">
                <label for="snow_blink_pause">Snow Blink Pause (in seconds)
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Sets the pause duration between each blink during the snow animation, in seconds.
                </div>
            </div>
            <input type="text" class="form-control input-small" name="snow_blink_pause" value="{{ config.SNOW_BLINK_PAUSE }}" placeholder="Default: 0.4">
        </div>
    </section>
    
    <!-- Time Settings Section -->
        <section id="time-settings">
            <h2>Time Settings</h2>

            <!-- Timezone Settings -->
            <div class="dropdown-container">
                <label style="display: flex; align-items: center;">
                    <h3 style="margin: 0;">Timezone Settings</h3>
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </label>
                <div class="dropdown-content" style="display: none;">
                    Select your timezone to ensure all time-based features work correctly.<br>
                    This will update the system timezone for accurate scheduling.
                </div>
            </div>
            <div class="service-control-panel">
                <select id="timezone-select" class="form-control" style="max-width: 300px; margin: 0 auto;">
                    <option value="">Loading timezones...</option>
                </select>
                <div id="timezone-status" style="margin-top: 10px;"></div>
            </div>

            <!-- Lights On Time -->
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="lights_on_time">Lights On Time (HH:MM)
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Set the time to turn on the LEDs
                    </div>
                </div>
                <select name="lights_on_time_hour" class="form-select inline-input">
                    {% for hour in range(0, 24) %}
                        <option value="{{ hour }}" {% if config.LIGHTS_ON_TIME.hour == hour %}selected{% endif %}>{{ "%02d" % hour }}</option>
                    {% endfor %}
                </select> :
                <select name="lights_on_time_minute" class="form-select inline-input">
                    {% for minute in range(0, 60, 5) %}
                        <option value="{{ minute }}" {% if config.LIGHTS_ON_TIME.minute == minute %}selected{% endif %}>{{ "%02d" % minute }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Lights Off Time -->
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="lights_off_time">Lights Off Time (HH:MM)
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Set the time to turn off the LEDs
                    </div>
                </div>
                <select name="lights_off_time_hour" class="form-select inline-input">
                    {% for hour in range(0, 24) %}
                        <option value="{{ hour }}" {% if config.LIGHTS_OFF_TIME.hour == hour %}selected{% endif %}>{{ "%02d" % hour }}</option>
                    {% endfor %}
                </select> :
                <select name="lights_off_time_minute" class="form-select inline-input">
                    {% for minute in range(0, 60, 5) %}
                        <option value="{{ minute }}" {% if config.LIGHTS_OFF_TIME.minute == minute %}selected{% endif %}>{{ "%02d" % minute }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Bright Time Start -->
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="bright_time_start">Bright Time Start (HH:MM)
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Set the time to return the LEDs to the default brightness
                    </div>
                </div>
                <select name="bright_time_start_hour" class="form-select inline-input">
                    {% for hour in range(0, 24) %}
                        <option value="{{ hour }}" {% if config.BRIGHT_TIME_START.hour == hour %}selected{% endif %}>{{ "%02d" % hour }}</option>
                    {% endfor %}
                </select> :
                <select name="bright_time_start_minute" class="form-select inline-input">
                    {% for minute in range(0, 60, 5) %}
                        <option value="{{ minute }}" {% if config.BRIGHT_TIME_START.minute == minute %}selected{% endif %}>{{ "%02d" % minute }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Dim Time Start -->
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="dim_time_start">Dim Time Start (HH:MM)
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        The time when the LEDs will change to night/dimmed brightness
                    </div>
                </div>
                <select name="dim_time_start_hour" class="form-select inline-input">
                    {% for hour in range(0, 24) %}
                        <option value="{{ hour }}" {% if config.DIM_TIME_START.hour == hour %}selected{% endif %}>{{ "%02d" % hour }}</option>
                    {% endfor %}
                </select> :
                <select name="dim_time_start_minute" class="form-select inline-input">
                    {% for minute in range(0, 60, 5) %}
                        <option value="{{ minute }}" {% if config.DIM_TIME_START.minute == minute %}selected{% endif %}>{{ "%02d" % minute }}</option>
                    {% endfor %}
                </select>
            </div>
        </section>

        <!-- Advanced Settings Section -->
        <section id="advanced-settings">
            <h2>Advanced Settings</h2>

            <!-- Number of Windy Animation Steps -->
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="num_steps">Number of Windy Animation Steps
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        How smooth the windy animation is. Recommended, 100
                    </div>
                </div>
                <input type="text" class="form-control input-small" name="num_steps" value="{{ config.NUM_STEPS }}" placeholder="Default: 100">
            </div>
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="num_pixels">Pixel Count
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Total number of pixels in your setup. (Should be at least as many lines in your airport file)
                    </div>
                </div>
                <input type="text" class="form-control input-small" name="num_pixels" value="{{ config.NUM_PIXELS }}" placeholder="i.e. 50">
            </div>
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="pixel_pin">Pixel Pin
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Enter the GPIO pin number only, e.g., "18".
                    </div>
                </div>
                <input type="text" class="form-control input-small" name="pixel_pin" value="{{ config.PIXEL_PIN }}" placeholder="i.e. 18">
            </div>
            <div class="mb-3">
                <div class="dropdown-container">
                    <label for="led_color_order">LED Color Order
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                    </label>
                    <div class="dropdown-content" style="display: none;">
                        Select the color order for your LED strip. Supported orders are:<br>
                        GRB: Standard for WS2811 Bullet style lights <br>
                        RGB: Common for NeoPixels
                    </div>
                </div>
                <select name="led_color_order" class="form-control input-small">
                    <option value="RGB" {% if config.LED_COLOR_ORDER == 'RGB' %}selected{% endif %}>RGB</option>  <!-- opposite GRB input for easy of coding -->
                    <option value="GRB" {% if config.LED_COLOR_ORDER == 'GRB' %}selected{% endif %}>GRB</option>
                </select>
            </div>
            <!-- Boolean Animations (Toggles) -->
            <div class="toggle-container">
                <div class="toggle-wrapper">
                    <!-- Dynamically set the 'checked' attribute based on the ENABLE_LIGHTS_OFF value -->
                    <input type="checkbox" id="enable_lights_off" name="enable_lights_off" class="toggle-input" {% if enable_lights_off %}checked{% endif %}>
                    <label for="enable_lights_off" class="toggle-label">Enable Lights On/Off Time</label>
                </div>
                <!-- Daytime Dimming Toggle -->
                <div class="toggle-wrapper">
                    <input type="checkbox" id="daytime_dimming" name="daytime_dimming" class="toggle-input" {% if config.DAYTIME_DIMMING %}checked{% endif %}>
                    <label for="daytime_dimming" class="toggle-label">Enable Daytime Dimming</label>
                </div>
                <!-- Wind Animation Toggle -->
                <div class="toggle-wrapper">
                    <input type="checkbox" id="wind_animation" name="wind_animation" class="toggle-input" {% if config.WIND_ANIMATION %}checked{% endif %}>
                    <label for="wind_animation" class="toggle-label">Enable Wind Animation</label>
                </div>
                <!-- Lightning Animation Toggle -->
                <div class="toggle-wrapper">
                    <input type="checkbox" id="lightening_animation" name="lightening_animation" class="toggle-input" {% if config.LIGHTENING_ANIMATION %}checked{% endif %}>
                    <label for="lightening_animation" class="toggle-label">Enable Lightning Animation</label>
                </div>
                <!-- Snowy Animation Toggle -->
                <div class="toggle-wrapper">
                    <input type="checkbox" id="snowy_animation" name="snowy_animation" class="toggle-input" {% if config.SNOWY_ANIMATION %}checked{% endif %}>
                    <label for="snowy_animation" class="toggle-label">Enable Snowy Animation</label>
                </div>
                <div class="toggle-wrapper">
                    <input type="checkbox" id="enable_https" name="enable_https" class="toggle-input" {% if enable_https %}checked{% endif %}>
                    <label for="enable_https" class="toggle-label">Enable HTTPS</label>
                </div>
                <div class="toggle-wrapper">
                    <input type="checkbox" id="update_weather" name="update_weather" class="toggle-input" {% if config.UPDATE_WEATHER %}checked{% endif %}>
                    <label for="update_weather" class="toggle-label">Enable Weather Updates</label>
                </div>
                <div class="toggle-wrapper">
                    <input type="checkbox" id="legend" name="legend" class="toggle-input" {% if legend %}checked{% endif %}>
                    <label for="legend" class="toggle-label">Enable LED Legend</label>
                    <div class="dropdown-container" style="margin-left: 10px;">
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false" onclick="event.stopPropagation()">i</span>
                        <div class="dropdown-content" style="display: none;">
                            When enabled, LEDs at the end of the strand will show what each color means.<br>
                            Starting from the end of the strand the colors are:<br>
                            Snowy, Windy, Lightning, Missing, LIFR, IFR, MVFR, VFR
                        </div>
                    </div>
                </div>
                <div class="toggle-wrapper">
                    <input type="checkbox" id="stale_indication" name="stale_indication" class="toggle-input" {% if config.STALE_INDICATION %}checked{% endif %}>
                    <label for="stale_indication" class="toggle-label">Enable Stale Data Indication</label>
                    <div class="dropdown-container" style="margin-left: 10px;">
                        <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false" onclick="event.stopPropagation()">i</span>
                        <div class="dropdown-content" style="display: none;">
                            When enabled, all LEDs will turn the set color if weather data becomes stale (more than 2x update interval old).<br>
                            This provides a visual indication that the weather data may be outdated.
                        </div>
                    </div>
                </div>
            </div>
        </section>

    <!-- Airports Section with Line Numbers -->
    <section id="airports" class="airports">
        <h2>Airports</h2>
        <label for="airportsText">ICAO Identifiers (one per line)</label>

        <div class="textarea-wrapper">
            <div class="line-numbers" id="line-numbers"></div>
            <textarea class="form-controltextarea" name="airports" id="airportsText" rows="10">{{ airports }}</textarea>
        </div>
    </section>

    <!-- WiFi Settings Section -->
    <section id="wifi-settings">
        <h2>WiFi Settings</h2>
        <text style="font-size: small;">NOTE: Save settings before connecting to a new netwrok</text>
    </br>
        <button id="scan-button" class="btn-primary">Scan for Networks</button>
        <div id="connection-status" class="mt-3"></div>
        <div id="network-dropdown" class="mt-4">
            <select id="ssid-select" name="ssid" class="form-control">
                <option value="">Scan First...</option>
            </select>
        </div>
        <div id="password-input" class="mt-3">
            <label for="wifi-password">Password (leave blank if open)</label>
            <input type="text" id="wifi-password" name="wifi-password" class="form-control" placeholder="Enter password" placeholder="Password Here">
        </div>
        <div class="mt-4">
            <button type="button" id="connect-button" class="btn-primary">Connect</button>
        </div>
    </section>
    <section>
    	<!-- Submit Button -->
    </br>
         NOTE: If you made chagnes to any settings above...
    </br>
        Be sure to click "Save" before restarting any services

     	<div class="mt-4">
    		<button type="submit" class="btn btn-primary" onclick="saveAndRestart()">Save</button>
    	</div>

    	<div class="mt-4">
    		<div class="dropdown-container">
    			<div>
    				<button type="button" class="btn btn-primary" onclick="updateWeatherManually()">Update Weather</button>
    			</div>
    			<div class="dropdown-content" style="display: none;">
    				This will force an immediate weather update for all airports.<br>
    				This works even when the METAR service is stopped.
    			</div>
    		</div>
    		<div style="margin-top: 5px;" class="weather-status">
    			<div class="service-status">
                    <span class="status-dot" id="update-weather-status-dot"></span>
                    <span class="status-text">WX Last Updated: <span id="update-weather-last-updated">{{ weather_last_modified }}</span></span>
                    <div class="status-tooltip">
                        <span class="green-status">Green: Weather data is current (within expected update interval)</span><br>
                        <span class="red-status">Red: Weather data is stale (no updates for over 2x the update interval)</span>
                    </div>
                </div>
    		</div>
    	</div>
    </section>

    <section>
        <h2>System Updates</h2>
        <div class="mb-3">
            <div class="dropdown-container">
                <div>
                    <button type="button" class="btn btn-primary" onclick="checkForUpdates()">Check for Updates</button>
                    <span class="tooltip-icon" tabindex="0" role="button" aria-expanded="false">i</span>
                </div>
                <div class="dropdown-content" style="display: none;">
                    This will check for updates from the Git repository.<br>
                    Your local configuration files (config.py and airports.txt) will be preserved during updates.<br>
                    A backup of all repository files will be created before updating.
                </div>
            </div>
            <div id="update-status" class="mt-3"></div>
            <div id="update-button-container" class="mt-3"></div>
        </div>
    </section>

    </form>
</div>

<div class="container">
    <!-- Service Controls Section -->
    <section>
        <h2>Service Controls</h2>
        <div class="service-info">
            <p>Local IP Address: <span class="ip-address">{{ local_ip }}</span></p>
        </div>

        <!-- METAR Service Controls -->
        <div class="service-control-panel">
            <h3>METAR Service</h3>
            <div class="service-status" id="metar-service-status">
                Status: <span class="status-dot"></span> <span class="status-text">Checking...</span>
            </div>
            <div class="service-buttons">
                <button class="btn btn-primary service-btn" onclick="controlService('metar', 'start')">Start</button>
                <button class="btn btn-primary service-btn" onclick="controlService('metar', 'stop')">Stop</button>
                <button class="btn btn-primary service-btn" onclick="controlService('metar', 'restart')">Restart</button>
                <button type="button" class="btn btn-primary service-btn" onclick="toggleLogs('metar')">Logs</button>
            </div>
            <div class="service-logs" id="metar-service-logs" style="display: none;">
                <pre class="logs-content"></pre>
            </div>
        </div>

        <!-- Settings Service Controls -->
        <div class="service-control-panel">
            <h3>Settings Service</h3>
            <div class="service-status" id="settings-service-status">
                Status: <span class="status-dot"></span> <span class="status-text">Checking...</span>
            </div>
            <div class="service-buttons">
                <button class="btn btn-primary service-btn" onclick="controlService('settings', 'start')">Start</button>
                <button class="btn btn-primary service-btn" onclick="confirmSettingsStop()">Stop</button>
                <button class="btn btn-primary service-btn" onclick="controlService('settings', 'restart')">Restart</button>
                <button type="button" class="btn btn-primary service-btn" onclick="toggleLogs('settings')">Logs</button>
            </div>
            <div class="service-logs" id="settings-service-logs" style="display: none;">
                <pre class="logs-content"></pre>
            </div>
        </div>

        <!-- Scheduler Service Controls -->
        <div class="service-control-panel">
            <h3>Scheduler Service</h3>
            <div class="service-status" id="scheduler-service-status">
                Status: <span class="status-dot"></span> <span class="status-text">Checking...</span>
            </div>
            <div class="service-buttons">
                <button class="btn btn-primary service-btn" onclick="controlService('scheduler', 'start')">Start</button>
                <button class="btn btn-primary service-btn" onclick="controlService('scheduler', 'stop')">Stop</button>
                <button class="btn btn-primary service-btn" onclick="controlService('scheduler', 'restart')">Restart</button>
                <button type="button" class="btn btn-primary service-btn" onclick="toggleLogs('scheduler')">Logs</button>
            </div>
            <div class="service-logs" id="scheduler-service-logs" style="display: none;">
                <pre class="logs-content"></pre>
            </div>
        </div>
    </section>
</div>

<script type="text/javascript">
    // Add color variables for the map
    const VFR_COLOR = '{{ vfr_color }}';
    const MVFR_COLOR = '{{ mvfr_color }}';
    const IFR_COLOR = '{{ ifr_color }}';
    const LIFR_COLOR = '{{ lifr_color }}';
    const MISSING_COLOR = '{{ missing_color }}';
    const LIGHTENING_COLOR = '{{ lightening_color }}';
    const SNOWY_COLOR = '{{ snowy_color }}';

    // Set CSS variables for the map
    document.documentElement.style.setProperty('--vfr-color', VFR_COLOR);
    document.documentElement.style.setProperty('--mvfr-color', MVFR_COLOR);
    document.documentElement.style.setProperty('--ifr-color', IFR_COLOR);
    document.documentElement.style.setProperty('--lifr-color', LIFR_COLOR);
    document.documentElement.style.setProperty('--missing-color', MISSING_COLOR);
    document.documentElement.style.setProperty('--lightening-color', LIGHTENING_COLOR);
    document.documentElement.style.setProperty('--snowy-color', SNOWY_COLOR);

    // Set legend dot colors directly
    document.addEventListener('DOMContentLoaded', function() {
        // Get all legend dots
        const vfrDot = document.querySelector('.legend-dot.vfr');
        const mvfrDot = document.querySelector('.legend-dot.mvfr');
        const ifrDot = document.querySelector('.legend-dot.ifr');
        const lifrDot = document.querySelector('.legend-dot.lifr');
        const missingDot = document.querySelector('.legend-dot.missing');
        
        // Set colors directly
        if (vfrDot) vfrDot.style.backgroundColor = VFR_COLOR;
        if (mvfrDot) mvfrDot.style.backgroundColor = MVFR_COLOR;
        if (ifrDot) ifrDot.style.backgroundColor = IFR_COLOR;
        if (lifrDot) lifrDot.style.backgroundColor = LIFR_COLOR;
        if (missingDot) missingDot.style.backgroundColor = MISSING_COLOR;
    });

    const messages = [];
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                messages.push({ category: '{{ category }}', message: '{{ message }}' });
            {% endfor %}
        {% endif %}
    {% endwith %}
</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

<script>
    // Add constants
    const WEATHER_UPDATE_THRESHOLD = {{ weather_update_threshold }};
    
    // Call initially and set interval
    updateWeatherStatus();
    setInterval(updateWeatherStatus, 30000); // Update every 30 seconds
</script>

<script>
    // Set CSS variables for legend colors
    document.addEventListener('DOMContentLoaded', function() {
        document.documentElement.style.setProperty('--vfr-color', '{{ vfr_color }}');
        document.documentElement.style.setProperty('--mvfr-color', '{{ mvfr_color }}');
        document.documentElement.style.setProperty('--ifr-color', '{{ ifr_color }}');
        document.documentElement.style.setProperty('--lifr-color', '{{ lifr_color }}');
        document.documentElement.style.setProperty('--missing-color', '{{ missing_color }}');
        document.documentElement.style.setProperty('--lightening-color', '{{ lightening_color }}');
        document.documentElement.style.setProperty('--snowy-color', '{{ snowy_color }}');
    });
</script>

</body>
</html>